<!DOCTYPE html>
<!--
        Galactic Outlaw - an HTML5 game 
        Copyright (C) 2014 Jonas "sanojian" Olmstead 
        
        Artwork - Oryx (http://oryxdesignlab.com/)
        Music - Deceased Superior Technician (http://www.nosoapradio.us/)
        
        Thanks for buzzjs and craftyjs!
-->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<title>Galactic Outlaw</title>
	<script type="text/javascript" src="./includes/crafty.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript" src="./includes/buzz.min.js"></script>
	<link href='//fonts.googleapis.com/css?family=Press+Start+2P' rel='stylesheet' type='text/css'>
	<style>
		body, html { margin:0; padding: 0; overflow:hidden; font-family:Arial; font-size:20px }
		#cr-stage { border:2px solid black; margin:5px auto; color:white }
		
		div.shipSlot {
			background-image: url("./images/shipSlot.png");
			width: 120px;
			height: 48px;
			display: inline-block;
			margin: 3px 12px;
		}
		div.powerBar {
			background-color: #1B9916;
			position: relative;
			left: 6px;
			top: 15px;
			width: 0px;
			height: 18px;
		}
		#divInventory {
			width: 144px;
			height: 144px;
			background-image: url("./images/shipInventory.png");
			padding: 0;
		}
		div.shipPart {
			width: 48px;
			height: 48px;
			background-image: url("./images/partBackground.png");
			display: inline-block;
			cursor: pointer;
			position: absolute;
			z-index: 6000;
		}
		
		.icon {
			width:24px;
			height:24px;
			background:url(./images/lofi_scifi_v2.png) no-repeat;
		}
		
		.icon.icon-weapon {background-position: -216px -1824px}
		.icon.icon-shield {background-position: -48px -1800px}
		.icon.icon-engine {background-position: -48px -1848px}
		.icon.part { margin: 12px }
			
	</style>
	
	<script language="javascript">
"use strict";


var RENDERING_MODE = 'Canvas';
var GAME_FONT = '"Press Start 2P", cursive';
var TILE_SIZE = 8*3;
var VIEW_WIDTH = 960 - 144; //28*TILE_WIDTH;
var VIEW_HEIGHT = 640; //10*TILE_HEIGHT;

var g_game = {
	collideEffects: {
		objArray: [],
		cursor: 0,
		getNextEffect: function () {
			g_game.collideEffects.cursor = (g_game.collideEffects.cursor + 1) % g_game.collideEffects.objArray.length;
			return g_game.collideEffects.objArray[g_game.collideEffects.cursor];
		}
	},
	exhaustEffects: {
		objArray: [],
		cursor: 0,
		getNextEffect: function () {
			g_game.exhaustEffects.cursor = (g_game.exhaustEffects.cursor + 1) % g_game.exhaustEffects.objArray.length;
			return g_game.exhaustEffects.objArray[g_game.exhaustEffects.cursor];
		}
	},
	parts: {},
	sounds: {},
	music: {},
	curLevel: 0
};

var generateUid = function (separator) {
	var delim = separator || "-";

	function S4() {
		return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
	}

	return (S4() + S4() + delim + S4() + delim + S4() + delim + S4() + delim + S4() + S4() + S4());
};

function ShipPart(type, regen, pow) {
	this.guid = generateUid();
	this.type = type;
	this.regen = regen;
	this.power = pow || 0;
	this.readyToUse = true;

	this.getInfo = function () {
		return {};
	};

	this.tick = function () {
		if (this.type == 'engine') {
			this.changePower(this.regen);
		}
		else {
			var powLeft = Math.min(this.regen, g_game.player.shipConfiguration.engine[0].power);
			var curPow = this.power;
			this.changePower(powLeft);
			var change = this.power - curPow;
			g_game.player.shipConfiguration.engine[0].changePower(-change);
		}
	};
	
	this.fire = function(x, y, direction, id, dmg) {
		if (this.readyToUse)
			this.readyToUse = false;
			this.changePower(-20);
			var self = this;
			setTimeout(function() {
				self.readyToUse = true;
			}, 1000);
			Crafty.e('Bullet').Bullet(x, y, direction, id, dmg);
	
	};

	this.changePower = function (amt) {
		this.power = Math.min(100, Math.max(0, this.power + amt));
	};

	var icon = type;
	$('#divGUI').append('<div class="shipPart" data-guid="' + this.guid + '"><div class="icon icon-' + icon + ' part" title="' + type + '"/></div>');

	this.$image = $('div.shipPart[data-guid=' + this.guid + ']');
};

function Inventory() {

	this.count = 0;
	this.slots = [];
	for (var i = 0; i < 9; i++) {
		this.slots.push({
			contents: undefined
		});
	}

	this.addPart = function (part) {
		// find empty slot
		for (var i = 0; i < this.slots.length; i++) {
			if (this.slots[i].contents == undefined) {
				this.slots[i].contents = part;
				var posInv = $('#divInventory').offset();
				part.$image.css({
					top: posInv.top + Math.floor(i / 3) * 16 * 3,
					left: posInv.left + (i % 3) * 16 * 3
				});
				this.count += 1;
				return i;
			}
		}
		return -1;
	};

	this.removePart = function (part) {
		for (var i = 0; i < this.slots.length; i++) {
			if (this.slots[i].contents == part) {
				this.slots[i].contents = undefined;
				part.comesFrom = {
					place: 'inventory',
					slot: i
				};
			}
		}
	};
};

function ShipSlot(index) {

	this.index = index;

	$('#divShipParts').append('<div class="shipSlot" data-slot="' + index + '"></div>');
	this.$slotImage = $('div.shipSlot[data-slot=' + index + ']');
	this.$slotImage.append('<div class="powerBar" />');
	this.$slotPower = this.$slotImage.find('.powerBar');

	this.tick = function () {
		if (this.part) {
			this.part.tick();
			this.$slotPower.css('width', 60 * this.part.power / 100);
		} else {
			this.$slotPower.css('width', 0);
		}
	};

	this.addPart = function (part) {
		this.part = part;
		//part.power = part.power;
		var posSlot = this.$slotImage.offset();
		this.part.$image.css({
			top: posSlot.top,
			left: posSlot.left + this.$slotImage.width() - part.$image.width()
		});
		if (part.type == 'shield') {
			g_game.player.addShield(part);
		}
		g_game.player.reconfigureShip();
	};
	this.removePart = function (part) {
		if (this.part == part) {
			this.part = undefined;
			part.comesFrom = {
				place: 'slot',
				slot: index
			};
			if (part.type == 'shield') {
				g_game.player.removeShield();
			}
		}
		g_game.player.reconfigureShip();
	};

}

window.addEventListener("load", function (event) {

	//VIEW_WIDTH = $(document).width();
	//VIEW_HEIGHT = $(document).height();
	Crafty.init(VIEW_WIDTH, VIEW_HEIGHT);

	initCraftySpace();
	initCraftySurface();
	initCraftyScenes();

	$('#divGUI').on('mousedown', 'div.shipPart', function (e) {
		$('div.shipPart').css('z-index', 6000);
		$(this).css('z-index', 9000);
		g_game.draggedPart = g_game.parts[$(e.currentTarget).attr('data-guid')];
		g_game.shipInventory.removePart(g_game.draggedPart);
		for (var i = 0; i < g_game.shipSlots.length; i++) {
			g_game.shipSlots[i].removePart(g_game.draggedPart);
		}
	});
	$('#divGUI').on('mousemove', 'div.shipPart', function (e) {
		if (g_game.draggedPart && g_game.draggedPart.guid == $(e.currentTarget).attr('data-guid')) {
			$(e.currentTarget).css({
				top: e.pageY - $(e.currentTarget).height() / 2,
				left: e.pageX - $(e.currentTarget).width() / 2
			});
		}
	});
	$('#divGUI').on('mouseup', 'div.shipPart', function (e) {
		var posDragged = $(e.currentTarget).offset();
		var cX = posDragged.left + $(e.currentTarget).width() / 2;
		var cY = posDragged.top + $(e.currentTarget).height() / 2;

		var posInv = $('#divInventory').offset();
		var bFoundPos = false;
		if (cX >= posInv.left && cY >= posInv.top && cX <= posInv.left + $('#divInventory').width() && cY <= posInv.top + $('#divInventory').height()) {
			g_game.shipInventory.addPart(g_game.draggedPart);
			bFoundPos = true;
		}
		if (!bFoundPos) {
			for (var i = 0; i < 5; i++) {
				var $slot = $('div.shipSlot[data-slot=' + i + ']');
				var posSlot = $slot.offset();
				if (cX >= posSlot.left && cY >= posSlot.top && cX <= posSlot.left + $slot.width() && cY <= posSlot.top + $slot.height()) {
					if (!g_game.shipSlots[i].part) {
						g_game.shipSlots[i].addPart(g_game.draggedPart);
						bFoundPos = true;
						i = 5;
					}
				}
			}
		}
		if (!bFoundPos) {
			// send it back where it came from
			if (g_game.draggedPart.comesFrom.place == 'inventory') {
				g_game.shipInventory.addPart(g_game.draggedPart);
			} else if (g_game.draggedPart.comesFrom.place == 'slot') {
				g_game.shipSlots[g_game.draggedPart.comesFrom.slot].addPart(g_game.draggedPart);
			}
		}

		g_game.draggedPart = undefined;
	});
});

function layoutGUI() {
	$('#divGUI').show();
	var pos = $('#cr-stage').offset();

	//$('#divOverlay').css({ width: $('#cr-stage').width(), height: $('#cr-stage').height(), left: pos.left+2, top: pos.top+2 });
	$('#canvasMiniMap').css({
		width: 48 * 3,
		height: 48 * 3,
		left: pos.left + 12 + $('#cr-stage').width(),
		top: pos.top + 12
	});

	g_game.shipInventory = new Inventory();
	g_game.shipSlots = [];

	$('#divShipParts').css({
		width: 48 * 3,
		left: pos.left + 12 + $('#cr-stage').width(),
		top: pos.top + $('#canvasMiniMap').height() + 24
	});
	for (var i = 0; i < 5; i++) {
		g_game.shipSlots.push(new ShipSlot(i));
	}

	var posParts = $('#divShipParts').offset();
	$('#divInventory').css({
		width: 144,
		height: 144,
		left: pos.left + 12 + +$('#cr-stage').width(),
		top: pos.top + $('#cr-stage').height() - 48 * 3 - 6
	});
	var posInv = $('#divInventory').offset();

	$('#divControls').css({
		width: 144,
		height: 96,
		left: pos.left + 12,
		top: pos.top + $('#cr-stage').height() - 48 * 3 - 6,
		visibility: 'hidden'
	});

	var drawingCanvas = document.getElementById('canvasMiniMap');
	var context = drawingCanvas.getContext('2d');
	context.scale(2, 1);

}

function updateMiniMap() {
	var drawingCanvas = document.getElementById('canvasMiniMap');
	var context = drawingCanvas.getContext('2d');

	//context.scale(1, 1);
	for (var y = 0; y <= 49; y++) {
		context.fillStyle = y % 2 ? '#394677' : '#4A5B99';
		for (var x = 0; x <= 49; x++) {
			context.fillRect(x * 3, y * 3, 3, 3);
		}
	}

	// view area
	//context.strokeStyle = '#4A5B99';
	var w = VIEW_WIDTH / (8);
	var h = VIEW_HEIGHT / (8);
	var edgeX = 24 * 3 - w/2;
	var edgeY = 24 * 3 - h/2;
	context.lineWidth = 3;
	context.strokeRect(edgeX, edgeY, w, h);
	
	function fillDot(dotX, dotY, dotW, dotH) {
		// in view area?
		var dx = dotX - g_game.player.x;
		var dy = dotY - g_game.player.y;
		if (Math.abs(dx) <= VIEW_WIDTH/2 && Math.abs(dy) <= VIEW_HEIGHT/2) {
			context.fillRect(24 * 3 + dx / 8, 24 * 3 + dy / 8, dotW, dotH);
		}
		else {
			var x = 24 * 3 + dx / 8;
			var y = 24 * 3 + dy / 8;
			if (Math.abs(dx) > VIEW_WIDTH/2 && dx < 0) {
				x = edgeX - (Math.abs(dx)/8 - w/2)/10;
			}
			else if (Math.abs(dx) > VIEW_WIDTH/2 && dx > 0) {
				x = edgeX + w + (Math.abs(dx)/8 - w/2)/10;
			}
			if (Math.abs(dy) > VIEW_HEIGHT/2 && dy < 0) {
				y = edgeY - (Math.abs(dy)/8 - h/2)/10;
			}
			else if (Math.abs(dy) > VIEW_HEIGHT/2 && dy > 0) {
				y = edgeY + h + (Math.abs(dy)/8 - h/2)/10;
			}
			context.fillRect(x, y, dotW, dotH);
		}
	};

	// ships
	context.fillStyle = '#0f0';
	var shipIDs = Crafty('faction1');
	for (var i = 0; i < shipIDs.length; i++) {
		var ship = Crafty(shipIDs[i]);
		fillDot(ship.x, ship.y, 3, 3);
	}

	context.fillStyle = '#f00';
	var shipIDs = Crafty('faction2');
	for (var i = 0; i < shipIDs.length; i++) {
		var ship = Crafty(shipIDs[i]);
		fillDot(ship.x, ship.y, 3, 3);
	}

	// player
	context.fillStyle = '#00f';
	context.fillRect(24 * 3, 24 * 3, 3, 3);
	
	// planets
	context.fillStyle = '#fff';
	var planetIDs = Crafty('Planet');
	for (var i = 0; i < planetIDs.length; i++) {
		var planet = Crafty(planetIDs[i]);
		fillDot(planet.x, planet.y, 6, 6);
	}

}

function getParameterByName(name) {
	name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
	return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function initCraftySurface() {

	Crafty.c('Mob', {
		Mob: function (type) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, SpriteAnimation, ' + type)
				.attr({	z: 100 })
				.collision()
				.reel('WalkRight', 300, [[this.__coord[0] + 0*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 1*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 2*TILE_SIZE, this.__coord[1]]])
				.reel('WalkDown', 300, [[this.__coord[0] + 3*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 4*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 5*TILE_SIZE, this.__coord[1]]])
				.reel('WalkLeft', 300, [[this.__coord[0] + 6*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 7*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 8*TILE_SIZE, this.__coord[1]]])
				.reel('WalkUp', 300, [[this.__coord[0] + 9*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 10*TILE_SIZE, this.__coord[1]], [this.__coord[0] + 11*TILE_SIZE, this.__coord[1]]])
				.bind('NewDirection', function(dir) {
					if (dir.x > 0) {
						this.animate('WalkRight', -1);
					}
					else if (dir.x < 0) {
						this.animate('WalkLeft', -1);
					}
					else if (dir.y < 0) {
						this.animate('WalkUp', -1);
					}
					else if (dir.y > 0) {
						this.animate('WalkDown', -1);
					}
					else {
						this.pauseAnimation();
					}
				})
				.bind('Moved', function(from) {
					if (this.hit('solid')) {
						this.attr({ x: from.x, y: from.y });
					}
				})

			return this;
		}
	});

	Crafty.c('PlayerMan', {
		PlayerMan: function (type) {
			this.requires('Mob, Fourway')
				.fourway(2)
				.Mob(type)
				
			return this;
		}
	});
	
	Crafty.c('AIMob', {
		direction: { x: 0, y: 0 },
		
		AIMob: function (type) {
			this.requires('Mob, Delay')
				.bind('EnterFrame', function(frameObj) {
					var from = { x: this.x, y: this.y };
					this.attr({ x: this.x + this.direction.x, y: this.y + this.direction.y });
					this.trigger('Moved', from);
				})
				.Mob(type)
			
			this.walkRandomDirection();
			
			return this;
		},
		walkRandomDirection: function() {
			this.direction = { x: 1 - Math.floor(Math.random()*3), y: 1 - Math.floor(Math.random()*3) };
			this.trigger('NewDirection', this.direction);
			var self = this;
			this.delay(function() { self.walkRandomDirection(); }, 1500);
		}
	});
	
}

function initCraftySpace() {

	Crafty.c('Ship', {
		maxSpeed: 2,

		Ship: function (x, y, type, faction) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, solid, ' + type + ',' + faction)
				.attr({
					x: x,
					y: y,
					z: 100
				})
				.collision()
				.bind('EnterFrame', function (frameObj) {
					var speed = this.velocity.magnitude();
					if (speed > this.maxSpeed) {
						this.velocity = this.velocity.scale(this.maxSpeed / speed);
					}
					this.attr({
						x: this.x + this.velocity.x,
						y: this.y + this.velocity.y
					});
					if (this.shield && frameObj.frame % 10 == 0) {
						this.shield.alpha = 1 * this.shieldPart.power / 100;
					}
				})
				.origin('center')


			this.velocity = new Crafty.math.Vector2D(0, 0);
			this.direction = new Crafty.math.Vector2D(0, 0);
			this.turn(0);
			this.hitPoints = 3;
			this.maxHitPoints = 3;

			return this;
		},
		addShield: function (part) {
			this.shield = Crafty.e('2D, ' + RENDERING_MODE + ', shield')
				.attr({
					x: this.x + this.w / 2 - 16 * 3 / 2,
					y: this.y + this.h / 2 - 16 * 3 / 2,
					z: 100,
					alpha: 0.5
				});
			this.attach(this.shield);
			this.shieldPart = part;
		},
		removeShield: function () {
			this.detach(this.shield);
			this.shield.destroy();
			this.shieldPart = undefined;
			this.shield = undefined;
		},
		turn: function (amt) {
			this.rotation = (this.rotation + amt) % 360;
			var vY = 1 * Math.sin(this.rotation * Math.PI / 180);
			var vX = 1 * Math.cos(this.rotation * Math.PI / 180);
			this.direction.setValues(vX, vY);
		},
		takeDamage: function (amt) {
			if (this.shield && this.shieldPart.power > 20) {
				this.shieldPart.changePower(-amt * 20);
			} else {
				this.hitPoints = Math.max(0, this.hitPoints - amt);
				for (var i = 0; i < 2; i++) {
					g_game.collideEffects.getNextEffect().show(this.x, this.y);
				}
				if (this.hitPoints <= 0) {
					for (var i = 0; i < 3; i++) {
						g_game.collideEffects.getNextEffect().show(this.x, this.y);
					}
					Crafty.e('SpaceLoot').SpaceLoot(this.x, this.y, this.velocity);
					this.destroy();
				}
			}
		}
	});

	Crafty.c('AIShip', {

		AIShip: function (x, y, type, faction, enemyFaction, home) {
			this.requires('Ship')
				.Ship(x, y, type, faction)
				.bind('EnterFrame', function (frameObj) {
					var enemies = Crafty(enemyFaction);
					var bEnemyFound = false;
					for (var i=0;!bEnemyFound && i<enemies.length;i++) {
						
						var target = Crafty(enemies[0]);
						// turn towards enemy
						var dx = target.x - this.x;
						var dy = target.y - this.y;
						var dist = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
						if (dist < 1200) {
							bEnemyFound = true;
							this.chaseTarget(target, frameObj);
							var angleToTarget = Math.atan2(dy, dx);
							var rotationRads = this.rotation * Math.PI / 180;
							var angleDiff = rotationRads - angleToTarget;
							angleDiff = (angleDiff + Math.PI) % (Math.PI * 2) - Math.PI;
							// fire?
							if (Math.abs(angleDiff) < Math.PI / 4 && frameObj.frame % 100 == 0) {
								Crafty.e('Bullet').Bullet(this.x, this.y, this.direction, this[0], 2);
							}
						}
					}
					if (!bEnemyFound) {
						// go home
						this.chaseTarget(home, frameObj);
					}
				})

			return this;
		},
		chaseTarget: function(target, frameObj) {
			// turn towards enemy
			var dx = target.x - this.x;
			var dy = target.y - this.y;
			var dist = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
			var angleToTarget = Math.atan2(dy, dx);
			var rotationRads = this.rotation * Math.PI / 180;
			var angleDiff = rotationRads - angleToTarget;
			angleDiff = (angleDiff + Math.PI) % (Math.PI * 2) - Math.PI;
			if (angleDiff < 0) {
				this.turn(1);
			} else if (angleDiff > 0) {
				this.turn(-1);
			}
			// chase?
			if (Math.abs(angleDiff) < Math.PI / 4 && dist > 200) {
				this.velocity.add(new Crafty.math.Vector2D(this.direction.x * 0.02, this.direction.y * 0.02));
				if (frameObj.frame % 10 == 0) {
					g_game.exhaustEffects.getNextEffect().show(this.x + this.w / 2, this.y + this.h / 2);
				}
			}
		
		}
	});


	Crafty.c('PlayerShip', {

		PlayerShip: function (x, y) {
			this.requires('Keyboard, Ship, Delay')
				.Ship(x, y, 'ship', 'faction1')
				.bind('EnterFrame', function (frameObj) {
					if (this.isDown(Crafty.keys.UP_ARROW) || this.isDown(Crafty.keys.W)) {
						this.velocity.add(new Crafty.math.Vector2D(this.direction.x * 0.05, this.direction.y * 0.05));
						if (frameObj.frame % 10 == 0) {
							g_game.exhaustEffects.getNextEffect().show(this.x + this.w / 2, this.y + this.h / 2);
						}
					}
					if (this.isDown(Crafty.keys.LEFT_ARROW) || this.isDown(Crafty.keys.A)) {
						this.turn(-4);
					}
					if (this.isDown(Crafty.keys.RIGHT_ARROW) || this.isDown(Crafty.keys.D)) {
						this.turn(4);
					}
					if (this.isDown(Crafty.keys.SPACE)) {
						for (var i=0;i<this.shipConfiguration.weapon.length;i++) {
							if (this.shipConfiguration.weapon[i].readyToUse && this.shipConfiguration.weapon[i].power >= 20) {
								this.shipConfiguration.weapon[i].fire(this.x, this.y, this.direction, this[0], 2);
							}
						}
					}
					
					var planets = this.hit('Planet');
					if (planets) {
						loadMap('test1');
					}
					
					if (frameObj.frame % 10 == 0) {
						for (var i = 0; i < g_game.shipSlots.length; i++) {
							g_game.shipSlots[i].tick();
						}
					}

					g_game.$stage.css('background-position', '' + Math.floor(-this.x / 4) + 'px ' + Math.floor(-this.y / 4) + 'px');
					updateMiniMap();
				})

			return this;
		},
		reconfigureShip: function() {
			this.shipConfiguration = {
				weapon: [],
				shield: [],
				engine: []
			}
			for (var i = 0; i < g_game.shipSlots.length; i++) {
				if (g_game.shipSlots[i].part) {
					this.shipConfiguration[g_game.shipSlots[i].part.type].push(g_game.shipSlots[i].part);
				}
			}		
		}
	});

	Crafty.c('Planet', {

		Planet: function (x, y, type) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, ' + type)
				.attr({	x: x, y: y,	z: 60 })
				.collision([this.w/2-8, this.h/2-8], [this.w/2+8, this.h/2-8], [this.w/2+8, this.h/2+8], [this.w/2-8, this.h/2+8])
			return this;
		}
	});

	Crafty.c('Bullet', {
		range: 1000,
		speed: 10,

		Bullet: function (x, y, dir, sourceId, damage) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, bullet')
				.attr({
					x: x,
					y: y,
					z: 100
				})
				.collision()
				.bind('EnterFrame', function (frameObj) {
					this.attr({
						x: this.x + this.velocity.x,
						y: this.y + this.velocity.y
					});
					this.travelled += Math.sqrt(Math.pow(this.velocity.x, 2) + Math.pow(this.velocity.y, 2));
					var hits = this.hit('solid');
					if (hits) {
						if (hits[0].obj[0] != sourceId) {
							if (hits[0].obj.has('Ship')) {
								hits[0].obj.takeDamage(damage);
							}
							this.destroy();
							return;
						}
					}
					if (this.travelled > this.range) {
						this.destroy();
					}
				})

			this.velocity = new Crafty.math.Vector2D(dir.x * this.speed, dir.y * this.speed);
			this.travelled = 0;

			return this;
		}
	});

	Crafty.c('SpaceLoot', {
		SpaceLoot: function (x, y, v) {
			this.requires('2D, ' + RENDERING_MODE + ', loot, Collision, Delay')
				.attr({
					x: x,
					y: y,
					z: 90
				})
				.bind('EnterFrame', function (frameObj) {
					this.attr({
						x: this.x + this.velocity.x,
						y: this.y + this.velocity.y
					});
					if (this.hit('PlayerShip')) {
						var newPart = new ShipPart('weapon', 11);
						g_game.parts[newPart.guid] = newPart;
						g_game.shipInventory.addPart(newPart);
						this.destroy();
					}
				})
				.collision()

			this.velocity = v.scale(0.1);
			return this;
		}
	});

	Crafty.c('Exhaust', {
		Exhaust: function () {
			this.requires('2D, ' + RENDERING_MODE + ', exhaust, Delay')
				.attr({
					z: 80
				})

			this.visible = false;
			return this;
		},
		show: function (x, y) {
			this.attr({
				x: x,
				y: y
			})
			this.visible = true;
			var self = this;
			this.delay(function () {
				self.visible = false;
			}, 1000);
		}
	});

	Crafty.c('Fragment', {
		Fragment: function () {
			this.requires('2D, ' + RENDERING_MODE + ', fragment, Delay')
				.attr({
					z: 100
				})
				.bind('EnterFrame', function (frameObj) {
					if (this.visible) {
						this.attr({
							x: this.x + this.velocity.x,
							y: this.y + this.velocity.y
						});
					}
				})

			this.visible = false;
			this.range = 100;
			this.speed = 4;
			this.direction = new Crafty.math.Vector2D(-1 + Math.random() * 2, -1 + Math.random() * 2);
			this.velocity = new Crafty.math.Vector2D(this.direction.x * this.speed, this.direction.y * this.speed);

			return this;
		},
		show: function (x, y) {
			this.attr({
				x: x,
				y: y,
				z: 100
			})
			this.direction = new Crafty.math.Vector2D(-1 + Math.random() * 2, -1 + Math.random() * 2);
			this.velocity = new Crafty.math.Vector2D(this.direction.x * this.speed, this.direction.y * this.speed);
			this.visible = true;
			var self = this;
			this.delay(function () {
				self.visible = false;
			}, 250 + Math.random() * 500);
		}
	});

}

function loadMap(strMap) {
		
	$.getJSON('./maps/' + strMap + '.json?' + Math.random(), function(data) {
		
		for (var i=0;i<data.tilesets.length;i++) {
			var myMap = new Object();
			var width = data.tilesets[i].imagewidth / data.tilesets[i].tilewidth;
			var height = data.tilesets[i].imageheight / data.tilesets[i].tileheight;
			
			for (var y=0;y<height;y++)
				for (var x=0;x<width;x++) 
					myMap['maptile_' + (data.tilesets[i].firstgid + y*width+x)] = [x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE];

			Crafty.sprite(1, './maps/' + data.tilesets[i].image, myMap);
		}
		
		g_game.map = data;
		
		Crafty.scene("planetSurface"); //when everything is loaded, run the main scene
		
	});

}

function initCraftyScenes() {
	
	Crafty.scene("planetSurface", function () {
		Crafty.background('url(./images/background.png)');

		$('#divGUI').css('visibility', 'hidden');
		g_game.$stage = $('#cr-stage');
		var startX = 300;
		var startY = 220;

		for (var i=0;i<g_game.map.layers.length;i++) {
			if (g_game.map.layers[i].type == 'objectgroup') {
				// objects
				for (var j=0;j<g_game.map.layers[i].objects.length;j++) {
					var obj = g_game.map.layers[i].objects[j];
					//var el = Crafty.e(obj.properties.components)[obj.properties.components]('maptile_' + obj.gid)
					//				.attr({ x: obj.x, y: obj.y });
					var el = Crafty.e('2D, ' + RENDERING_MODE + ', maptile_' + obj.gid)
								.attr({ x: obj.x, y: obj.y });
					if (obj.properties && obj.properties.entity) {
						el.addComponent(obj.properties.entity);
						el[obj.properties.entity]('maptile_' + obj.gid);
					}
					
				}
			}
			else {
				// tiles
				for (var y=0;y<g_game.map.layers[i].height;y++) {
					for (var x=0;x<g_game.map.layers[i].width;x++) {
						var tile = g_game.map.layers[i].data[x + y * g_game.map.layers[i].width];
						if (tile > 0) {
							var el = Crafty.e('2D, ' + RENDERING_MODE + ', maptile_' + g_game.map.layers[i].data[x + y * g_game.map.layers[i].width])
										.attr({ x: x * g_game.map.tilewidth, y: y * g_game.map.tileheight, z: 1 });
							if (g_game.map.layers[i].properties && g_game.map.layers[i].properties.components && g_game.map.layers[i].properties.components.indexOf('solid') != -1) {
								el.addComponent('solid').addComponent('Collision').collision();
							}
						}
					}
				}
			}
		}
		
		//Crafty.e('bigShip').attr( { x: 200, y: 220, z: 20 });
		
		//g_game.player = Crafty.e('PlayerMan').PlayerMan().attr({ x: startX, y: startY });
		g_game.player = Crafty(Crafty('PlayerMan')[0]);
		Crafty.viewport.clampToEntities = false;
		Crafty.viewport.follow(g_game.player, g_game.player.w / 2, g_game.player.h / 2);
		
		//Crafty.e('AIMob').AIMob('alienMan').attr({ x: startX-50, y: startY-50 });;
		//Crafty.e('AIMob').AIMob('alienBlob').attr({ x: startX-100, y: startY-50 });;
		
		//Crafty.e('AIMob').AIMob('cat').attr({ x: startX+100, y: startY });;
		
	});

	Crafty.scene("main", function () {
		Crafty.background('url(./images/background.png)');


		for (var i = 0; i < 10; i++) {
			g_game.collideEffects.objArray.push(Crafty.e('Fragment').Fragment());
		}
		for (var i = 0; i < 20; i++) {
			g_game.exhaustEffects.objArray.push(Crafty.e('Exhaust').Exhaust());
		}

		$('#divGUI').css('visibility', 'visible');
		g_game.$stage = $('#cr-stage');
		var startX = 500;
		var startY = 500;


		g_game.player = Crafty.e('PlayerShip').PlayerShip(startX, startY);
		Crafty.viewport.clampToEntities = false;
		Crafty.viewport.follow(g_game.player, g_game.player.w / 2, g_game.player.h / 2);

		g_game.planets = [];
		g_game.planets.push(Crafty.e('Planet').Planet(startX + 100, startY + 100, 'planet1' ));
		g_game.planets.push(Crafty.e('Planet').Planet(startX - 400, startY + 900, 'planet2' ));
		g_game.planets.push(Crafty.e('Planet').Planet(startX + 1200, startY - 300, 'planet3' ));

		Crafty.e('AIShip').AIShip(startX - 100, startY - 100, 'friendShip1', 'faction1', 'faction2', g_game.planets[0]);
		Crafty.e('AIShip').AIShip(startX + 1200, startY - 300, 'friendShip1', 'faction1', 'faction2', g_game.planets[2]);

		Crafty.e('AIShip').AIShip(startX + 200, startY + 10, 'enemyShip' + Math.floor(1 + Math.random()*6), 'faction2', 'faction1', g_game.planets[0]);
		Crafty.e('AIShip').AIShip(startX + 400, startY + 100, 'enemyShip' + Math.floor(1 + Math.random()*6), 'faction2', 'faction1', g_game.planets[0]);
		Crafty.e('AIShip').AIShip(startX + 300, startY + 200, 'motherShip', 'faction2', 'faction1', g_game.planets[0]);
		
		// some inventory
		var newPart = new ShipPart('weapon', 11);
		g_game.parts[newPart.guid] = newPart;
		g_game.shipInventory.addPart(newPart);
		var newPart = new ShipPart('shield', 3);
		g_game.parts[newPart.guid] = newPart;
		g_game.shipInventory.addPart(newPart);

		var newPart = new ShipPart('weapon', 11, 0);
		g_game.parts[newPart.guid] = newPart;
		g_game.shipSlots[2].addPart(newPart);
		var newPart = new ShipPart('shield', 3, 0);
		g_game.parts[newPart.guid] = newPart;
		g_game.shipSlots[3].addPart(newPart);
		var newPart = new ShipPart('engine', 3, 100);
		g_game.parts[newPart.guid] = newPart;
		g_game.shipSlots[4].addPart(newPart);
		
	});

	Crafty.scene("loading", function () {
		Crafty.background("#000");
		//try {
		Crafty.e('2D, ' + RENDERING_MODE + ', Text').attr({
			w: 800,
			h: 20,
			x: VIEW_WIDTH / 2 - 400,
			y: VIEW_HEIGHT / 2 - 160,
			z: 1000
		})
			.text("Loading...")
			.textColor('#fff', 1)
			.textFont({
				size: "16pt",
				weight: 'bold',
				family: GAME_FONT
			})
		//.css({ "text-align": "center", "font-family": GAME_FONT, "font-size": "44px" });
		//} catch (ex) {;}

		Crafty.load(['./images/lofi_scifi_v2.png'], function () {

			Crafty.sprite(1, './images/lofi_scifi_v2.png', {
				ship: [2 * TILE_SIZE, 34 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				friendShip1: [22 * TILE_SIZE, 35 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				enemyShip1: [2 * TILE_SIZE, 43 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				enemyShip2: [2 * TILE_SIZE, 44 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				enemyShip3: [2 * TILE_SIZE, 45 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				enemyShip4: [2 * TILE_SIZE, 46 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				enemyShip5: [2 * TILE_SIZE, 47 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				enemyShip6: [2 * TILE_SIZE, 48 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				motherShip: [19 * TILE_SIZE, 49 * TILE_SIZE, TILE_SIZE*2, TILE_SIZE*2],
				bigShip: [2 * TILE_SIZE, 49 * TILE_SIZE, TILE_SIZE*2, TILE_SIZE*2],

				bullet: [8 * TILE_SIZE, 78 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				fragment: [8 * TILE_SIZE, 77 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				shield: [88 * 3, 644 * 3, 16 * 3, 16 * 3],
				exhaust: [163 * 3, 612 * 3, 1 * 3, 1 * 3],

				planet1: [8 * 3, 664 * 3, 24 * 3, 24 * 3],
				planet2: [8 * 3 + 24 * 3, 664 * 3, 24 * 3, 24 * 3],
				planet3: [0, 664 * 3 + 24 * 3, 40 * 3, 40 * 3],
				loot:	[8 * 3, 632*3, 8*3, 8*3],
				
				playerMan: [1* TILE_SIZE, 3 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				alienBlob: [16* TILE_SIZE, 6 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				cat: [16* TILE_SIZE, 7 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				alienMan: [16* TILE_SIZE, 5 * TILE_SIZE, TILE_SIZE, TILE_SIZE]
			});


			layoutGUI();
			//Crafty.scene("main");
			loadMap('test1');


		});
	});

	Crafty.scene("loading");
}

	</script>
</head>
<body style="background-color: #444;" unselectable="on" onselectstart="return false;" >
	<div id="divGUI" style="width: 100%; height: 100%; visiblity: hidden;">
		<canvas id="canvasMiniMap" style="position: absolute;z-index: 5000; opacity: 0.6;"></canvas>
		<div id="divShipParts" style="position: absolute;z-index: 5000;"></div>
		<!--div id="divOverlay" style="background-image: url(./images/meshx3.png);background-repeat:repeat;position: absolute;z-index: 8000"></div--> 
		<div id="divControls" style="position: absolute;z-index: 5000;">
			<img src="./images/arrows.png" />
		</div>
		<div id="divInventory" style="position: absolute;z-index: 5000;"></div>
	</div>        
</body>