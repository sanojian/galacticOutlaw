<!DOCTYPE html>
<!--
	Galactic Outlaw - an HTML5 game 
	Copyright (C) 2014 Jonas "sanojian" Olmstead 
	
	Artwork - Oryx (http://oryxdesignlab.com/)
	Music - Deceased Superior Technician (http://www.nosoapradio.us/)
	
	Thanks for buzzjs and craftyjs!
-->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<title>Galactic Outlaw</title>
	<script type="text/javascript" src="./includes/crafty.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript" src="./includes/buzz.min.js"></script>
	<link href='//fonts.googleapis.com/css?family=Press+Start+2P' rel='stylesheet' type='text/css'>
	<style>
		body, html { margin:0; padding: 0; overflow:hidden; font-family:Arial; font-size:20px }
		#cr-stage { border:2px solid black; margin:5px auto; color:white }
		
	</style>
	
	<script language="javascript">
"use strict";


var RENDERING_MODE = 'Canvas';
var GAME_FONT = '"Press Start 2P", cursive';
var TILE_SIZE = 8*3;
var VIEW_WIDTH = 960; //28*TILE_WIDTH;
var VIEW_HEIGHT = 640; //10*TILE_HEIGHT;

var g_game = {
	collideEffects: {
		objArray: [],
		cursor: 0,
		getNextEffect: function() {
			g_game.collideEffects.cursor = (g_game.collideEffects.cursor + 1) % g_game.collideEffects.objArray.length;
			return g_game.collideEffects.objArray[g_game.collideEffects.cursor];
		}
	},
	exhaustEffects: {
		objArray: [],
		cursor: 0,
		getNextEffect: function() {
			g_game.exhaustEffects.cursor = (g_game.exhaustEffects.cursor + 1) % g_game.exhaustEffects.objArray.length;
			return g_game.exhaustEffects.objArray[g_game.exhaustEffects.cursor];
		}
	},
	sounds: {},
	music: {},
	curLevel: 0
};

window.addEventListener("load", function(event) {

	//VIEW_WIDTH = $(document).width();
	//VIEW_HEIGHT = $(document).height();
	Crafty.init(VIEW_WIDTH, VIEW_HEIGHT);
	
	doCraftyInitialization();
});

function layoutGUI() {
	$('#divGUI').show();
	var pos = $('#cr-stage').offset();

	$('#canvasMiniMap').css({ width: 48*3, height: 48*3, left: pos.left+3, top: pos.top + $('#cr-stage').height() - 48*3 - 6 });

}

function updateMiniMap() {
	var drawingCanvas = document.getElementById('canvasMiniMap');
	var context = drawingCanvas.getContext('2d');
	
	for (var y=0;y<48;y++) {
		context.fillStyle = y % 2 ? '#394677' : '#4A5B99';
		for (var x=0;x<48;x++) {
			context.fillRect(x*6,y*3,6,3);
		}
	}

	// player
	context.fillStyle = '#0f0';
	var player = Crafty(Crafty('Player')[0]);
	context.fillRect(24*6,24*3,6,3);
	
	// ships
	context.fillStyle = '#f00';
	var shipIDs = Crafty('AIShip');
	for (var i=0;i<shipIDs.length;i++) {
		var ship = Crafty(shipIDs[i]);
		context.fillRect(24*6 + ship.x/8 - player.x/8, 24*3 + ship.y/8 - player.y/8,6,3);
	}

	// planets
	context.fillStyle = '#fff';
	var shipIDs = Crafty('planet');
	for (var i=0;i<shipIDs.length;i++) {
		var ship = Crafty(shipIDs[i]);
		context.fillRect(24*6 + ship.x/8 - player.x/8, 24*3 + ship.y/8 - player.y/8,12,6);
	}
	
}
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function doCraftyInitialization() {
	
	Crafty.c('Ship', {
		maxSpeed: 2,
		
		Ship: function(x, y, type, faction) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, solid, ' + type + ',' + faction)
				.attr( { x: x, y: y, z: 100 } )
				.collision()
				.bind('EnterFrame', function(frameObj) {
					var speed = this.velocity.magnitude();
					if (speed > this.maxSpeed) {
						this.velocity = this.velocity.scale(this.maxSpeed/speed);
					}
					this.attr( { x: this.x + this.velocity.x, y: this.y + this.velocity.y });
				})
				.origin('center')
				
			
			this.velocity =  new Crafty.math.Vector2D(0,0);
			this.direction =  new Crafty.math.Vector2D(0,0);
			this.turn(0);
			this.hitPoints = 3;
			this.maxHitPoints = 3;
			
			this.shield = Crafty.e('2D, ' + RENDERING_MODE + ', shield')
				.attr( { x: this.x + this.w/2 - 16*3/2, y: this.y + this.h/2 - 16*3/2, z: 100, alpha: 0.5 } );
			this.attach(this.shield);
			this.shieldStrength = 6;
			this.maxShieldStrength = 6;
			
			
			return this;
		},
		turn: function(amt) {
			//var angle = Math.atan2(this.direction.y, this.direction.x);
			//angle += amt;
			this.rotation = (this.rotation + amt) % 360;
			var vY = 1 * Math.sin(this.rotation * Math.PI / 180);
			var vX = 1 * Math.cos(this.rotation * Math.PI / 180);
			this.direction.setValues(vX, vY);
		},
		takeDamage: function(amt) {
			if (this.shieldStrength > 0) {
				this.shieldStrength = Math.max(0, this.shieldStrength - amt);
				this.shield.alpha = 0.5 * this.shieldStrength / this.maxShieldStrength;
			}
			else {
				this.hitPoints = Math.max(0, this.hitPoints - amt);
				for (var i=0;i<2;i++) {
					g_game.collideEffects.getNextEffect().show(this.x, this.y);
				}
				if (this.hitPoints <= 0) {
					for (var i=0;i<3;i++) {
						g_game.collideEffects.getNextEffect().show(this.x, this.y);
					}
					this.destroy();
				}
			}
		}
	});

	Crafty.c('AIShip', {
		
		AIShip: function(x, y, type, faction) {
			this.requires('Ship')
				.Ship(x, y, type, faction)
				.bind('EnterFrame', function(frameObj) {
					var enemies = Crafty('faction1');
					if (enemies.length) {
						var target = Crafty(enemies[0]);
						// turn towards enemy
						var dx = target.x - this.x;
						var dy = target.y - this.y;
						var dist = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2));
						var angleToTarget = Math.atan2(dy, dx);
						var rotationRads = this.rotation * Math.PI / 180;
						var angleDiff = rotationRads - angleToTarget;
						angleDiff = (angleDiff + Math.PI) % (Math.PI*2) - Math.PI;
						if (angleDiff < 0) {
							this.turn(1);
						}
						else if (angleDiff > 0) {
							this.turn(-1);
						}
						// chase?
						if (Math.abs(angleDiff) < Math.PI/4 && dist > 200) {
							this.velocity.add(new Crafty.math.Vector2D(this.direction.x*0.02, this.direction.y*0.02));
							if (frameObj.frame % 10 == 0) {
								g_game.exhaustEffects.getNextEffect().show(this.x + this.w/2, this.y + this.h/2);					
							}
						}
						// fire
						if (Math.abs(angleDiff) < Math.PI/4 && frameObj.frame % 100 == 0) {
							Crafty.e('Bullet').Bullet(this.x, this.y, this.direction, this[0]);						
						}
					}
				})
				
			return this;
		}
	});
	
	
	Crafty.c('Player', {

		Player: function(x, y) {
			this.requires('Keyboard, Ship')
				.Ship(x, y, 'ship', 'faction1')
				.bind('EnterFrame', function(frameObj) {
					if (this.isDown(Crafty.keys.UP_ARROW)) {
						this.velocity.add(new Crafty.math.Vector2D(this.direction.x*0.05, this.direction.y*0.05));
						if (frameObj.frame % 10 == 0) {
							g_game.exhaustEffects.getNextEffect().show(this.x + this.w/2, this.y + this.h/2);					
						}
					}
					if (this.isDown(Crafty.keys.LEFT_ARROW)) {
						this.turn(-4);
					}
					if (this.isDown(Crafty.keys.RIGHT_ARROW)) {
						this.turn(4);
					}

					g_game.$stage.css('background-position', '' + (-this.x/4) + 'px ' + (-this.y/4) + 'px');
					updateMiniMap();
				})
				.bind('KeyDown', function(evt) {
					if (evt.key == Crafty.keys.SPACE) {
						Crafty.e('Bullet').Bullet(this.x, this.y, this.direction, this[0]);
					}
				})
				
			
				
			return this;
		}
	});
	
	Crafty.c('Bullet', {
		range: 1000,
		speed: 10,
	
		Bullet: function(x, y, dir, sourceId) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, bullet')
				.attr( { x: x, y: y, z: 100 } )
				.collision()
				.bind('EnterFrame', function(frameObj) {
					this.attr( { x: this.x + this.velocity.x, y: this.y + this.velocity.y });
					this.travelled += Math.sqrt(Math.pow(this.velocity.x, 2) + Math.pow(this.velocity.y, 2));
					var hits = this.hit('solid');
					if (hits) {
						if (hits[0].obj[0] != sourceId) {
							if (hits[0].obj.has('Ship')) {
								hits[0].obj.takeDamage(1);
							}
							this.destroy();
							return;
						}
					}
					if (this.travelled > this.range) {
						this.destroy();
					}
				})
				
			this.velocity = new Crafty.math.Vector2D(dir.x*this.speed, dir.y*this.speed);
			this.travelled = 0;
			
			return this;
		}
	});

	Crafty.c('Exhaust', {
		Exhaust: function() {
			this.requires('2D, ' + RENDERING_MODE + ', exhaust, Delay')
				.attr( { z: 10 } )
	
			this.visible = false;
			return this;
		},
		show: function(x, y) {
			this.attr( { x: x, y: y } )
			this.visible = true;
			var self = this;
			this.delay(function() {
				self.visible = false;
			}, 1000);
		}		
	});
	
	Crafty.c('Fragment', {
		Fragment: function() {
			this.requires('2D, ' + RENDERING_MODE + ', fragment, Delay')
				.attr( { z: 100 } )
				.bind('EnterFrame', function(frameObj) {
					if (this.visible) {
						this.attr( { x: this.x + this.velocity.x, y: this.y + this.velocity.y });
					}
				})
		
			this.visible = false;
			this.range = 100;
			this.speed = 4;
			this.direction = new Crafty.math.Vector2D(-1 + Math.random()*2, -1 + Math.random()*2);
			this.velocity = new Crafty.math.Vector2D(this.direction.x*this.speed, this.direction.y*this.speed);
		
			return this;
		},
		show: function(x, y) {
			this.attr( { x: x, y: y, z: 100 } )
			this.direction = new Crafty.math.Vector2D(-1 + Math.random()*2, -1 + Math.random()*2);
			this.velocity = new Crafty.math.Vector2D(this.direction.x*this.speed, this.direction.y*this.speed);
			this.visible = true;
			var self = this;
			this.delay(function() {
				self.visible = false;
			}, 250 + Math.random()*500);
		}
	});
	
	
	Crafty.scene("main", function () {
		Crafty.background('url(./images/background.png)');	

		
		for (var i=0;i<10;i++) {
			g_game.collideEffects.objArray.push(Crafty.e('Fragment').Fragment());
		}
		for (var i=0;i<20;i++) {
			g_game.exhaustEffects.objArray.push(Crafty.e('Exhaust').Exhaust());
		}

		layoutGUI();
		g_game.$stage = $('#cr-stage');
		var startX = 500;
		var startY = 500;
		
		var player = Crafty.e('Player').Player(startX, startY);
		Crafty.viewport.clampToEntities = false;
		Crafty.viewport.follow(player, player.w/2, player.h/2);
	
		Crafty.e('2D, ' + RENDERING_MODE + ',planet, solid').attr({ x: startX + 100, y: startY + 100, z: 60 });
		Crafty.e('AIShip').AIShip(startX + 200, startY + 10, 'ship2', 'faction2');
		Crafty.e('AIShip').AIShip(startX + 400, startY + 100, 'ship2', 'faction2');
		Crafty.e('AIShip').AIShip(startX + 300, startY + 200, 'ship2', 'faction2');
	});

	Crafty.scene("loading", function () {
		Crafty.background("#000");
		//try {
		Crafty.e('2D, ' + RENDERING_MODE + ', Text').attr({ w: 800, h: 20, x: VIEW_WIDTH/2 - 400, y: VIEW_HEIGHT/2-160, z: 1000 })
			.text("Loading...")
			.textColor('#fff', 1)
			.textFont({ size: "16pt", weight: 'bold', family: GAME_FONT })
			//.css({ "text-align": "center", "font-family": GAME_FONT, "font-size": "44px" });
		//} catch (ex) {;}
		
		Crafty.load(['./images/lofi_scifi_v2.png'	], function() {
					
			Crafty.sprite(1, './images/lofi_scifi_v2.png', {
				ship: 		[2 * TILE_SIZE, 34 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				ship2: 		[2 * TILE_SIZE, 43 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				
				bullet:		[8 * TILE_SIZE, 78 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				fragment: 	[8 * TILE_SIZE, 77 * TILE_SIZE, TILE_SIZE, TILE_SIZE],
				shield:		[88 * 3, 644*3, 16*3, 16*3],
				exhaust:	[163*3, 612*3, 1*3, 1*3],
				
				planet: 	[8*3, 664*3, 24*3, 24*3]
			});

		
			Crafty.scene("main");
			
		});
	});
	
	Crafty.scene("loading");
}


	</script>
</head>
<body>
	<div id="divGUI" style="width: 100%, height: 100%">
	
		<canvas id="canvasMiniMap" style="position: absolute;z-index: 5000; border: 2px solid; opacity: 0.8;"></canvas>
	</div>	
</body>
